<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marina İndirimi | Göcek Lokantası</title>
  <meta name="description" content="Göcek Lokantası Marina indirimi kod üretimi ve doğrulama ekranı." />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#101826;
      --card2:#0f1724;
      --text:#e7edf6;
      --muted:#9fb0c7;
      --line:rgba(255,255,255,.08);
      --accent:#78ead3;
      --accent2:#f88451;
      --danger:#ff5c5c;
      --ok:#4ee59f;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --max:1080px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% -10%, rgba(120,234,211,.20), transparent 60%),
                  radial-gradient(1000px 600px at 90% 10%, rgba(248,132,81,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:28px 18px 80px}

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px;
      padding:14px 14px;
      border:1px solid var(--line);
      background: rgba(16,24,38,.55);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:12px; object-fit:cover;
      border:1px solid var(--line);
      background:#0d131d;
    }
    .brand b{font-size:16px; letter-spacing:.2px}
    .brand span{display:block; color:var(--muted); font-size:12px; margin-top:1px}

    nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(15,23,36,.55);
      color: var(--text);
      font-size: 13px;
      transition: .15s ease;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(120,234,211,.35)}
    .pill.primary{background: rgba(120,234,211,.14); border-color: rgba(120,234,211,.32)}
    .pill.orange{background: rgba(248,132,81,.14); border-color: rgba(248,132,81,.32)}

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr}
      nav{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--line);
      background: rgba(16,24,38,.62);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .card .hd h1,.card .hd h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .card .hd p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.4}
    .card .bd{padding:16px}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1}
    .row .fixed{flex:0 0 auto}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(8,12,18,.65);
      color: var(--text);
      outline:none;
    }
    input:focus, textarea:focus{border-color: rgba(120,234,211,.45)}
    .hint{color:var(--muted); font-size:12px; margin-top:8px}

    button{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(120,234,211,.14);
      border-color: rgba(120,234,211,.32);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-weight:600;
      transition:.15s ease;
    }
    button:hover{transform: translateY(-1px)}
    button.secondary{
      background: rgba(255,255,255,.04);
      border-color: var(--line);
      font-weight:600;
    }
    button.danger{
      background: rgba(255,92,92,.10);
      border-color: rgba(255,92,92,.28);
    }

    .status{
      margin-top:10px;
      border-radius: 14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 13px;
      line-height:1.35;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .status.ok{display:block; border-color: rgba(78,229,159,.35); background: rgba(78,229,159,.08)}
    .status.err{display:block; border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08)}
    .status.info{display:block; border-color: rgba(120,234,211,.28); background: rgba(120,234,211,.06)}

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
    }
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:left}
    th{color: var(--muted); font-weight:600; background: rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    .kbd{
      display:inline-flex; align-items:center; justify-content:center;
      padding:3px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }

    /* Floating actions */
    .fab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      display:flex;
      flex-direction: column;
      gap:10px;
      z-index: 50;
    }
    .fab a{
      width: 50px; height: 50px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(16,24,38,.70);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      transition:.15s ease;
    }
    .fab a:hover{transform: translateY(-2px)}
    .fab svg{width:22px; height:22px; opacity:.92}
    footer{
      margin-top: 16px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="assets/logo.jpg" alt="Göcek Lokantası logo" />
        <div>
          <b>Göcek Lokantası</b>
          <span>Marina İndirimi • Kod Yönetimi</span>
        </div>
      </div>

      <nav>
        <a class="pill" href="index.html">Ana Sayfa</a>
        <a class="pill primary" href="marina.html">Marina İndirimi</a>
        <a class="pill" href="dashboard.html">Dashboard</a>
        <a class="pill" id="btnWhatsapp" href="#" rel="noopener">WhatsApp</a>
        <a class="pill orange" id="btnMaps" href="#" rel="noopener">Konum</a>
        <a class="pill" id="btnInstagram" href="#" rel="noopener">Instagram</a>
      </nav>
    </header>

    <div class="grid">
      <!-- LEFT: Generate / Use -->
      <section class="card">
        <div class="hd">
          <h1>Marina İndirimi Kod Sistemi</h1>
          <p>
            <span class="kbd">PS001</span> formatında pedestal/star seçip kod üret.
            Ardından gelen kodu kasada doğrula.
          </p>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label for="pedalstar">Pedalstar ID</label>
              <input id="pedalstar" placeholder="PS001" autocomplete="off" />
              <div class="hint">Format: <b>PS</b> + 3 hane (örn: PS001, PS014)</div>
            </div>
            <div class="fixed">
              <label>&nbsp;</label>
              <button id="btnGenerate">Kod Üret</button>
            </div>
          </div>

          <div id="genStatus" class="status"></div>

          <hr style="border:none;border-top:1px solid var(--line); margin:16px 0">

          <div class="row">
            <div>
              <label for="codeToUse">Kodu Kullan / Doğrula</label>
              <input id="codeToUse" placeholder="Örn: GL-AB12CD" autocomplete="off" />
              <div class="hint">Kasada okutulan/okunan kodu buraya gir.</div>
            </div>
            <div class="fixed">
              <label>&nbsp;</label>
              <button id="btnUse" class="secondary">Kodu Kullan</button>
            </div>
          </div>

          <div id="useStatus" class="status"></div>
        </div>
      </section>

      <!-- RIGHT: Latest list -->
      <aside class="card">
        <div class="hd">
          <h2>Son Üretilen Kodlar</h2>
          <p>Seçilen pedestalstar’a göre listele. (Boşsa hepsi)</p>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label for="filterPedalstar">Filtre (opsiyonel)</label>
              <input id="filterPedalstar" placeholder="PS001" autocomplete="off" />
            </div>
            <div class="fixed">
              <label>&nbsp;</label>
              <button id="btnRefresh" class="secondary">Yenile</button>
            </div>
          </div>

          <div id="listStatus" class="status"></div>

          <div style="margin-top:10px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Kod</th>
                  <th>Pedalstar</th>
                  <th>Durum</th>
                  <th>Bitiş</th>
                </tr>
              </thead>
              <tbody id="listBody">
                <tr><td colspan="4" style="color:var(--muted)">Liste henüz yüklenmedi.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      © <span id="year"></span> Göcek Lokantası
    </footer>
  </div>

  <!-- Floating actions (sağ alt) -->
  <div class="fab" aria-label="Hızlı erişim">
    <a id="fabWhatsapp" href="#" title="WhatsApp">
      <!-- WhatsApp icon -->
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path fill="currentColor" d="M12.04 2C6.58 2 2.15 6.33 2.15 11.69c0 1.89.56 3.64 1.52 5.12L2 22l5.35-1.58c1.41.77 3.03 1.21 4.69 1.21 5.46 0 9.89-4.33 9.89-9.69C21.93 6.33 17.5 2 12.04 2Zm0 17.86c-1.52 0-2.93-.41-4.16-1.12l-.3-.17-3.17.94.95-3.05-.2-.31a7.88 7.88 0 0 1-1.27-4.33c0-4.39 3.65-7.96 8.15-7.96s8.15 3.57 8.15 7.96-3.65 8-8.15 8Zm4.48-5.78c-.24-.12-1.4-.69-1.62-.77-.22-.08-.38-.12-.54.12-.16.24-.62.77-.76.93-.14.16-.28.18-.52.06-.24-.12-1.02-.37-1.94-1.18-.72-.64-1.2-1.43-1.34-1.67-.14-.24-.01-.36.11-.48.11-.11.24-.28.36-.42.12-.14.16-.24.24-.4.08-.16.04-.3-.02-.42-.06-.12-.54-1.29-.74-1.77-.2-.48-.4-.41-.54-.42h-.46c-.16 0-.42.06-.64.3-.22.24-.84.82-.84 2 0 1.18.86 2.32.98 2.48.12.16 1.69 2.58 4.1 3.62.57.25 1.02.4 1.37.51.58.18 1.1.15 1.51.09.46-.07 1.4-.57 1.6-1.12.2-.55.2-1.02.14-1.12-.06-.1-.22-.16-.46-.28Z"/>
      </svg>
    </a>

    <a id="fabMaps" href="#" title="Konum">
      <!-- Map pin icon -->
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path fill="currentColor" d="M12 2c-3.86 0-7 3.14-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7Zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5Z"/>
      </svg>
    </a>

    <a id="fabInstagram" href="#" title="Instagram">
      <!-- Instagram icon -->
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm-5 4a5 5 0 1 1 0 10 5 5 0 0 1 0-10Zm0 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm5.25-2.1a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/>
      </svg>
    </a>
  </div>

  <script>
    // ====== SABİT SITE BİLGİLERİ (senin verdiğin değerler) ======
    const SITE = {
      WHATSAPP_NUMBER: "905394105058",
      INSTAGRAM_URL: "https://instagram.com/goceklokantasi",
      MAPS_DIRECTIONS_URL: "https://share.google/qVl6WHz6QGHft2Vl6"
    };

    // WhatsApp hazır mesaj
    const waText = "Merhaba, Göcek Lokantası marina indirimi hakkında bilgi almak istiyorum.";
    const waUrl  = `https://wa.me/${SITE.WHATSAPP_NUMBER}?text=${encodeURIComponent(waText)}`;

    // Linkleri butonlara bağla
    const bind = (id, url) => {
      const el = document.getElementById(id);
      if (el) el.href = url;
    };

    ["btnWhatsapp","fabWhatsapp"].forEach(id => bind(id, waUrl));
    ["btnInstagram","fabInstagram"].forEach(id => bind(id, SITE.INSTAGRAM_URL));
    ["btnMaps","fabMaps"].forEach(id => bind(id, SITE.MAPS_DIRECTIONS_URL));

    document.getElementById("year").textContent = new Date().getFullYear();

    // ====== UI helpers ======
    const $ = (id) => document.getElementById(id);

    function setStatus(el, type, msg){
      el.className = "status " + type;
      el.textContent = msg;
    }

    function clearStatus(el){
      el.className = "status";
      el.textContent = "";
      el.style.display = "none";
    }

    // Not: status class'ları display'i class ile açıyor; garanti için:
    const showStatus = (el, type, msg) => {
      setStatus(el, type, msg);
      el.style.display = "block";
    };

    function normalizePedalstar(input){
      return (input || "").trim().toUpperCase();
    }

    // ====== API calls (Netlify Functions) ======
    // Not: Param adında emin olamadığımız için 3 paramı birlikte gönderiyoruz
    // (generate.js hangi paramı okuyorsa onu yakalasın diye)
    async function apiGenerate(pedalstarId){
      const id = normalizePedalstar(pedalstarId);

      const qs = new URLSearchParams({
        pedalstar: id,
        pedalstar_id: id,
        pedalstarId: id
      });

      const url = `/.netlify/functions/generate?${qs.toString()}`;
      const res = await fetch(url, { method: "GET" });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, data };
    }

    async function apiUse(code){
      const c = (code || "").trim();

      // Önce POST dene
      let res = await fetch("/.netlify/functions/use", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: c })
      });

      if (res.ok){
        const data = await res.json().catch(() => ({}));
        return { ok:true, status: res.status, data };
      }

      // POST olmazsa GET fallback
      const qs = new URLSearchParams({ code: c });
      res = await fetch(`/.netlify/functions/use?${qs.toString()}`, { method:"GET" });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, data };
    }

    async function apiList(filterPedalstar){
      const id = normalizePedalstar(filterPedalstar);
      const qs = new URLSearchParams();
      if (id) {
        qs.set("pedalstar", id);
        qs.set("pedalstar_id", id);
        qs.set("pedalstarId", id);
      }
      const url = `/.netlify/functions/list${qs.toString() ? "?" + qs.toString() : ""}`;
      const res = await fetch(url, { method:"GET" });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, data };
    }

    // ====== Actions ======
    $("btnGenerate").addEventListener("click", async () => {
      const genStatus = $("genStatus");
      const pedalstarId = $("pedalstar").value;

      const id = normalizePedalstar(pedalstarId);
      if (!/^PS\d{3}$/.test(id)){
        showStatus(genStatus, "err", "Hatalı Pedalstar ID. Beklenen format: PS001");
        return;
      }

      showStatus(genStatus, "info", "Kod üretiliyor...");

      try{
        const r = await apiGenerate(id);

        if (!r.ok){
          const msg = r.data?.error || r.data?.message || "Kod üretilemedi.";
          showStatus(genStatus, "err", `${msg}\n(HTTP ${r.status})`);
          return;
        }

        // Beklenen alanlar: code, expires_at, pedalstar_id vb.
        const code = r.data?.code || r.data?.data?.code || r.data?.generated?.code || "";
        const expires = r.data?.expires_at || r.data?.data?.expires_at || r.data?.generated?.expires_at || "";
        const pId = r.data?.pedalstar_id || r.data?.pedalstar || r.data?.data?.pedalstar_id || id;

        let out = "Kod üretildi ✅\n";
        out += `Pedalstar: ${pId}\n`;
        if (code) out += `Kod: ${code}\n`;
        if (expires) out += `Bitiş: ${expires}\n`;

        if (!code){
          out += "\nNot: API cevap formatında 'code' alanı bulunamadı. generate.js çıktısını kontrol et.";
        }

        showStatus(genStatus, "ok", out);

        // Kullanım alanına otomatik yaz
        if (code) $("codeToUse").value = code;

        // Listeyi yenile
        await refreshList();
      }catch(e){
        showStatus(genStatus, "err", "Beklenmeyen hata: " + String(e));
      }
    });

    $("btnUse").addEventListener("click", async () => {
      const useStatus = $("useStatus");
      const code = ($("codeToUse").value || "").trim();
      if (code.length < 4){
        showStatus(useStatus, "err", "Kod boş/hatalı görünüyor.");
        return;
      }

      showStatus(useStatus, "info", "Kod doğrulanıyor/kullanılıyor...");

      try{
        const r = await apiUse(code);
        if (!r.ok){
          const msg = r.data?.error || r.data?.message || "Kod kullanılamadı.";
          showStatus(useStatus, "err", `${msg}\n(HTTP ${r.status})`);
          return;
        }

        let out = "Kod kullanıldı ✅\n";
        // muhtemel alanlar
        const usedAt = r.data?.used_at || r.data?.data?.used_at;
        const note   = r.data?.used_note || r.data?.data?.used_note;
        const pId    = r.data?.pedalstar_id || r.data?.data?.pedalstar_id;

        if (pId) out += `Pedalstar: ${pId}\n`;
        if (usedAt) out += `Kullanım: ${usedAt}\n`;
        if (note) out += `Not: ${note}\n`;

        showStatus(useStatus, "ok", out);

        await refreshList();
      }catch(e){
        showStatus(useStatus, "err", "Beklenmeyen hata: " + String(e));
      }
    });

    $("btnRefresh").addEventListener("click", refreshList);

    async function refreshList(){
      const listStatus = $("listStatus");
      const tbody = $("listBody");
      const filter = $("filterPedalstar").value;

      showStatus(listStatus, "info", "Liste yükleniyor...");

      try{
        const r = await apiList(filter);

        if (!r.ok){
          const msg = r.data?.error || r.data?.message || "Liste alınamadı.";
          showStatus(listStatus, "err", `${msg}\n(HTTP ${r.status})`);
          return;
        }

        // Beklenen: array
        const rows =
          (Array.isArray(r.data) ? r.data : null) ||
          (Array.isArray(r.data?.rows) ? r.data.rows : null) ||
          (Array.isArray(r.data?.data) ? r.data.data : null) ||
          [];

        if (!rows.length){
          showStatus(listStatus, "ok", "Liste boş (0 kayıt).");
          tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Kayıt bulunamadı.</td></tr>`;
          return;
        }

        // satır alanları farklı olabilir; esnek okuyalım
        tbody.innerHTML = rows.map((x) => {
          const code = x.code ?? x?.code_value ?? "";
          const p = x.pedalstar_id ?? x.pedalstar ?? "";
          const usedAt = x.used_at ?? null;
          const exp = x.expires_at ?? x.expires ?? "";
          const status = usedAt ? "Kullanıldı" : "Aktif";
          return `<tr>
            <td>${escapeHtml(String(code))}</td>
            <td>${escapeHtml(String(p))}</td>
            <td>${escapeHtml(String(status))}</td>
            <td>${escapeHtml(String(exp))}</td>
          </tr>`;
        }).join("");

        showStatus(listStatus, "ok", `Yüklendi ✅ (${rows.length} kayıt)`);
      }catch(e){
        showStatus(listStatus, "err", "Beklenmeyen hata: " + String(e));
      }
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Sayfa açılır açılmaz listeyi çek
    refreshList();
  </script>
</body>
</html>
