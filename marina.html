<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Göcek Lokantası — Marina İndirimi</title>
  <meta name="description" content="Göcek Lokantası marina indirimi için tek kullanımlık kod üretme ekranı." />
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#1a2438;
      --glass: rgba(14, 20, 33, .62);
      --glass2: rgba(14, 20, 33, .42);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.50);
      --ok: rgba(69, 255, 168, .95);
      --warn: rgba(255, 126, 126, .95);
      --btn: rgba(255,255,255,.10);
      --btnH: rgba(255,255,255,.14);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --pad: 18px;
      --pad2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(34, 211, 238, .18), transparent 58%),
        radial-gradient(900px 600px at 85% 20%, rgba(255, 146, 91, .18), transparent 60%),
        radial-gradient(1100px 700px at 60% 90%, rgba(99, 102, 241, .14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:22px 16px 40px}

    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(10px);
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:4px 8px;
      min-width: 240px;
    }
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid var(--stroke2);
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(255, 146, 91, .22), rgba(34, 211, 238, .18));
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .brandText{display:flex; flex-direction:column; line-height:1.05}
    .brandText b{font-size:14px; letter-spacing:.2px}
    .brandText span{font-size:12px; color:var(--muted2)}
    .nav{
      display:flex; gap:8px; align-items:center;
      flex:1 1 auto;
      justify-content:center;
      flex-wrap:wrap;
    }
    @media (max-width: 920px){
      .brand{min-width:auto}
      .nav{justify-content:flex-start}
    }
    .pill{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pill:hover{background:rgba(255,255,255,.10)}
    .pill.active{
      background:rgba(34,211,238,.14);
      border-color:rgba(34,211,238,.24);
    }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(10px);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding:18px}
    h1,h2{margin:0}
    .h{font-size:18px; letter-spacing:.2px}
    .p{margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.45}
    .hr{height:1px; background:var(--stroke); margin:14px 0}

    .row{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    label{display:block; font-size:12px; color:var(--muted2); margin:0 0 6px}
    .field{flex:1 1 260px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:14px;
      letter-spacing:.2px;
    }
    input:focus{border-color:rgba(34,211,238,.35); box-shadow:0 0 0 3px rgba(34,211,238,.10)}
    .btn{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      transition:.15s ease;
      min-width:120px;
    }
    .btn:hover{background:rgba(255,255,255,.14)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12.5px;
    }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      font-size:13px;
      display:none;
    }
    .msg.ok{border-color:rgba(69,255,168,.25); background:rgba(69,255,168,.08); color:rgba(234,255,245,.95)}
    .msg.err{border-color:rgba(255,126,126,.28); background:rgba(255,126,126,.08); color:rgba(255,232,232,.95)}
    .codeBox{
      margin-top:10px;
      padding:14px 14px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      display:none;
    }
    .codeRow{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:22px;
      letter-spacing:1px;
      font-weight:800;
    }
    .meta{color:var(--muted); font-size:12.5px}
    .smallBtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .smallBtn:hover{background:rgba(255,255,255,.10)}

    .steps{display:flex; flex-direction:column; gap:10px}
    .step{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
    }
    .step b{color:var(--text)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.86);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;
      border-radius:8px;
      white-space:nowrap;
    }

    .fab{
      position:fixed;
      right:18px;
      bottom:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:50;
    }
    .fab a{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(14, 20, 33, .60);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      transition:.15s ease;
    }
    .fab a:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .fab svg{width:20px; height:20px; opacity:.95}

    footer{
      margin-top:14px;
      color:rgba(255,255,255,.50);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="topbar" role="banner" aria-label="Üst Menü">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7.5 12.5c0 2.2 2 4 4.5 4s4.5-1.8 4.5-4" stroke="rgba(255,255,255,.85)" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M8 8.8c.8-1.5 2.2-2.5 4-2.5s3.2 1 4 2.5" stroke="rgba(255,255,255,.65)" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brandText">
          <b>Göcek Lokantası</b>
          <span>Marina İndirimi • Tek Kullanımlık Kod</span>
        </div>
      </div>

      <nav class="nav" aria-label="Sayfalar">
        <a class="pill" id="navHome" href="/">Ana Sayfa</a>
        <a class="pill active" id="navMarina" href="/marina">Marina indirimi</a>
        <a class="pill" id="navDashboard" href="/dashboard">Dashboard</a>
        <a class="pill" id="btnWhatsapp" href="#" rel="noopener">WhatsApp</a>
        <a class="pill" id="btnMaps" href="#" rel="noopener">Konum</a>
        <a class="pill" id="btnInstagram" href="#" rel="noopener">Instagram</a>
      </nav>
    </header>

    <main class="grid" role="main">
      <section class="card" aria-label="Kod Üret">
        <div class="cardInner">
          <h1 class="h">Marina İndirimi — Kod Üret</h1>
          <p class="p">
            Pedalstar/stand ID’niz <b>PS001</b> formatında olmalı. Kod üretince kasada gösterin. Kod <b>10 dakika</b> geçerlidir.
          </p>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label for="pedalstar">Pedalstar ID</label>
              <input id="pedalstar" inputmode="text" autocomplete="off" spellcheck="false" placeholder="PS001" />
            </div>
            <button class="btn" id="btnGenerate" type="button">Kod Üret</button>
          </div>

          <div class="hint">
            İpucu: QR linki şöyle olursa otomatik dolar → <span class="kbd">/marina?pedalstar=PS001</span>
          </div>

          <div class="msg err" id="msgErr"></div>
          <div class="msg ok" id="msgOk"></div>

          <div class="codeBox" id="codeBox">
            <div class="codeRow">
              <div>
                <div class="meta">Üretilen Kod</div>
                <div class="code" id="codeText">------</div>
              </div>
              <button class="smallBtn" id="btnCopy" type="button">Kopyala</button>
            </div>
            <div style="margin-top:8px" class="meta" id="expiresText">Bitiş: -</div>
          </div>

          <footer>© <span id="year"></span> Göcek Lokantası</footer>
        </div>
      </section>

      <aside class="card" aria-label="Nasıl Kullanılır">
        <div class="cardInner">
          <h2 class="h">Nasıl kullanılır?</h2>
          <div class="hr"></div>

          <div class="steps">
            <div class="step">
              <b>1)</b> Pedalstar ID alanına <b>PS001</b> gibi ID girin (QR otomatik doldurabilir).
            </div>
            <div class="step">
              <b>2)</b> <b>Kod Üret</b> ile kod oluşturun.
            </div>
            <div class="step">
              <b>3)</b> Kodu kasaya gösterin. Kod tek kullanımlıktır ve <b>10 dakika</b> geçerlidir.
            </div>
            <div class="step">
              Personel kontrol ekranı: <span class="kbd">/dashboard?token=...</span>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <div class="fab" aria-label="Hızlı Bağlantılar">
      <a id="fabWhatsapp" href="#" title="WhatsApp" rel="noopener">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21a9 9 0 1 0-7.7-4.3L3 21l4.5-1.2A8.9 8.9 0 0 0 12 21Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M9.6 10.2c.3-.6.6-.6.9-.6h.4c.2 0 .4 0 .6.4l.6 1.3c.1.3.1.5 0 .7l-.3.4c-.2.2-.3.4-.1.7.2.3.7 1.2 1.6 1.9.9.7 1.6.9 1.9 1 .3.1.5.1.7-.1l.5-.6c.2-.2.4-.3.7-.2l1.3.6c.4.2.4.4.4.6v.4c0 .3 0 .6-.6.9-.6.3-1.9.9-4.3-.4-2.4-1.4-4-3.9-4.1-4.2-.2-.3-1.3-1.8-.4-2.9Z" fill="rgba(255,255,255,.82)"/>
        </svg>
      </a>
      <a id="fabMaps" href="#" title="Konum" rel="noopener">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 22s7-5.2 7-12a7 7 0 1 0-14 0c0 6.8 7 12 7 12Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M12 13.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" fill="rgba(255,255,255,.82)"/>
        </svg>
      </a>
      <a id="fabInstagram" href="#" title="Instagram" rel="noopener">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8 3h8a5 5 0 0 1 5 5v8a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8a5 5 0 0 1 5-5Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
          <path d="M12 16.2a4.2 4.2 0 1 0 0-8.4 4.2 4.2 0 0 0 0 8.4Z" stroke="rgba(255,255,255,.85)" stroke-width="1.6"/>
          <path d="M17.6 6.4h.01" stroke="rgba(255,255,255,.85)" stroke-width="3" stroke-linecap="round"/>
        </svg>
      </a>
    </div>
  </div>

  <script>
    // SABİT BİLGİLER (güncellendi)
    const SITE = {
      WHATSAPP_NUMBER: "905394105058",
      INSTAGRAM_URL: "https://instagram.com/goceklokantasi",
      MAPS_DIRECTIONS_URL: "https://maps.app.goo.gl/Vf6fVwdSiV2JRdb36"
    };

    // LINKLER
    const waText = "Merhaba, marina indirimi hakkında bilgi alabilir miyim?";
    const waUrl = `https://wa.me/${SITE.WHATSAPP_NUMBER}?text=${encodeURIComponent(waText)}`;

    function bind(id, url) {
      const el = document.getElementById(id);
      if (el) el.href = url;
    }
    ["btnWhatsapp","fabWhatsapp"].forEach(id => bind(id, waUrl));
    ["btnInstagram","fabInstagram"].forEach(id => bind(id, SITE.INSTAGRAM_URL));
    ["btnMaps","fabMaps"].forEach(id => bind(id, SITE.MAPS_DIRECTIONS_URL));

    document.getElementById("year").textContent = new Date().getFullYear();

    const $ = (id) => document.getElementById(id);

    function showErr(text){
      $("msgOk").style.display = "none";
      $("msgOk").textContent = "";
      $("msgErr").style.display = "block";
      $("msgErr").textContent = text;
    }
    function showOk(text){
      $("msgErr").style.display = "none";
      $("msgErr").textContent = "";
      $("msgOk").style.display = "block";
      $("msgOk").textContent = text;
    }
    function clearMsgs(){
      $("msgErr").style.display = "none"; $("msgErr").textContent = "";
      $("msgOk").style.display = "none"; $("msgOk").textContent = "";
    }

    function normalizePedalstar(v){
      return (v || "").trim().toUpperCase();
    }

    // PS001 formatı (kesin)
    function isValidPedalstar(v){
      return /^PS\d{3}$/.test(v);
    }

    // ?pedalstar=PS001 veya ?pedalstar_id=PS001
    (function prefillFromQuery(){
      try{
        const u = new URL(location.href);
        const q = normalizePedalstar(u.searchParams.get("pedalstar") || u.searchParams.get("pedalstar_id") || "");
        if (q) $("pedalstar").value = q;
      }catch(e){}
    })();

    async function generateCode(){
      clearMsgs();
      $("codeBox").style.display = "none";

      const pedalstar = normalizePedalstar($("pedalstar").value);

      if (!isValidPedalstar(pedalstar)){
        showErr("Pedalstar ID hatalı. Örn: PS001");
        return;
      }

      $("btnGenerate").disabled = true;
      $("btnGenerate").textContent = "Üretiliyor...";

      try{
        // ÖNEMLİ: generate function hem pedalstar hem pedalstar_id kabul ediyor.
        const res = await fetch(`/.netlify/functions/generate?pedalstar_id=${encodeURIComponent(pedalstar)}`, {
          method: "GET",
          headers: { "accept": "application/json" }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data || data.ok !== true){
          const msg = (data && (data.error || data.detail)) ? (data.error || data.detail) : `Hata (HTTP ${res.status})`;
          showErr(String(msg));
          return;
        }

        $("codeText").textContent = data.code || "------";
        $("expiresText").textContent = `Bitiş: ${data.expires_at ? new Date(data.expires_at).toLocaleString("tr-TR") : "-"}`;
        $("codeBox").style.display = "block";
        showOk("Kod üretildi. Kasada gösterin.");

      }catch(e){
        showErr("Sunucu hatası: " + String(e));
      }finally{
        $("btnGenerate").disabled = false;
        $("btnGenerate").textContent = "Kod Üret";
      }
    }

    $("btnGenerate").addEventListener("click", generateCode);
    $("pedalstar").addEventListener("keydown", (e) => {
      if (e.key === "Enter") generateCode();
    });

    $("btnCopy").addEventListener("click", async () => {
      const t = $("codeText").textContent || "";
      if (!t || t === "------") return;
      try{
        await navigator.clipboard.writeText(t);
        showOk("Kod kopyalandı.");
      }catch(e){
        showErr("Kopyalanamadı. Kodu elle seçip kopyalayın.");
      }
    });
  </script>
</body>
</html>
