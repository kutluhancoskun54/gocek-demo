<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marina Kod Paneli</title>
  <style>
    :root{
      --bg:#f6f0e8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 16px 50px rgba(17,24,39,.08);
      --radius:18px;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:radial-gradient(1200px 600px at 30% 0%, #f8efe2 0%, var(--bg) 55%, #f5eee5 100%); color:var(--text);}
    .wrap{max-width:920px;margin:80px auto;padding:0 20px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:34px 34px 26px;}
    h1{margin:0 0 18px;font-size:28px;letter-spacing:-.02em}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .input{
      flex:1;min-width:240px;height:44px;border-radius:12px;border:1px solid var(--border);
      padding:0 14px;font-size:14px;outline:none;background:#fff;
    }
    .btn{
      height:44px;border-radius:12px;border:1px solid var(--border);
      padding:0 14px;font-weight:700;font-size:13px;cursor:pointer;background:#fff;
    }
    .btn.primary{background:#111827;color:#fff;border-color:#111827;}
    .meta{margin-left:auto;color:var(--muted);font-size:13px;display:flex;gap:14px;align-items:center}
    #msg{margin:10px 0 0;font-size:13px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:18px;font-size:13px}
    th,td{padding:12px 10px;border-top:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:800;letter-spacing:.02em}
    .footer{margin-top:18px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Marina Kod Paneli</h1>

      <div class="row">
        <input id="codeInput" class="input" placeholder="Kasada okunan 6 haneli kod" autocomplete="off" />
        <button id="btnUse" class="btn primary">Kodu doğrula (kullanıldı yap)</button>
        <button id="btnRefresh" class="btn">Listeyi yenile</button>
        <div class="meta">
          <span id="countText">Son 0 kayıt</span>
          <span id="rightStatus"></span>
        </div>
      </div>

      <div id="msg"></div>

      <table>
        <thead>
          <tr>
            <th>Durum</th>
            <th>Kod</th>
            <th>Pedalstar</th>
            <th>Üretim</th>
            <th>Bitiş</th>
            <th>Kullanım</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6">Kayıt yok.</td></tr>
        </tbody>
      </table>

      <div class="footer">Not: Panel URL’sinde token olmalı. Örn: <b>/dashboard?token=GL_ADMIN_...</b></div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const ADMIN_TOKEN = (qs.get("token") || qs.get("admin_token") || "").trim();

    const $ = (id) => document.getElementById(id);
    const setMsg = (text, isErr=false) => {
      const el = $("msg");
      el.textContent = text || "";
      el.style.color = isErr ? "#b00020" : "#0b6b2e";
      $("rightStatus").textContent = isErr ? "Unauthorized" : "";
      if (!text) $("rightStatus").textContent = "";
    };

    function fnUrl(name, extra = {}) {
      const u = new URL(`/.netlify/functions/${name}`, location.origin);
      if (ADMIN_TOKEN) u.searchParams.set("token", ADMIN_TOKEN);
      for (const [k,v] of Object.entries(extra)) {
        if (v !== undefined && v !== null && String(v).trim() !== "") u.searchParams.set(k, String(v));
      }
      return u.toString();
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function fmt(dt){
      if (!dt) return "-";
      try { return new Date(dt).toLocaleString("tr-TR"); } catch { return "-"; }
    }

    function render(rows){
      const tbody = $("tbody");
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6">Kayıt yok.</td></tr>`;
        $("countText").textContent = "Son 0 kayıt";
        return;
      }
      $("countText").textContent = `Son ${rows.length} kayıt`;
      tbody.innerHTML = rows.map(r => {
        const status = r.used_at ? "Kullanıldı" : "Aktif";
        return `
          <tr>
            <td>${esc(status)}</td>
            <td>${esc(r.code)}</td>
            <td>${esc(r.pedalstar_id)}</td>
            <td>${esc(fmt(r.created_at))}</td>
            <td>${esc(fmt(r.expires_at))}</td>
            <td>${esc(r.used_at ? fmt(r.used_at) : "-")}</td>
          </tr>
        `;
      }).join("");
    }

    async function refresh(){
      if (!ADMIN_TOKEN) return setMsg("Token yok. URL şu formatta olmalı: /dashboard?token=GL_ADMIN_...", true);
      try{
        setMsg("Liste çekiliyor...");
        const res = await fetch(fnUrl("list"));
        const data = await res.json().catch(()=>({}));
        if (!res.ok || data.ok !== true) return setMsg(data.error || `Liste alınamadı (${res.status})`, true);
        render(data.rows || []);
        setMsg("Liste güncellendi.");
      }catch(e){
        console.error(e);
        setMsg("Liste alınırken hata oluştu.", true);
      }
    }

    async function markUsed(){
      if (!ADMIN_TOKEN) return setMsg("Token yok. URL şu formatta olmalı: /dashboard?token=GL_ADMIN_...", true);
      const code = ($("codeInput").value || "").trim().toUpperCase();
      if (!code) return setMsg("Kod gir.", true);
      try{
        setMsg("Kod doğrulanıyor...");
        const res = await fetch(fnUrl("use", { code }));
        const data = await res.json().catch(()=>({}));
        if (!res.ok || data.ok !== true) return setMsg(data.error || `İşlem başarısız (${res.status})`, true);
        setMsg(data.already_used ? "Kod zaten kullanılmış." : "Kod kullanıldı olarak işaretlendi.");
        await refresh();
      }catch(e){
        console.error(e);
        setMsg("Kod doğrulanırken hata oluştu.", true);
      }
    }

    $("btnRefresh").addEventListener("click", refresh);
    $("btnUse").addEventListener("click", markUsed);
    $("codeInput").addEventListener("keydown", (e)=>{ if (e.key === "Enter") markUsed(); });

    refresh();
  </script>
</body>
</html>
