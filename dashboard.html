<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marina Kod Paneli</title>
  <style>
    :root{
      --bg:#fbf6ee;
      --card:#ffffff;
      --line:#e9dfd1;
      --text:#1f1f1f;
      --muted:#6b6b6b;
      --accent:#2b2b2b;
      --btn:#111;
      --btnText:#fff;
      --danger:#b00020;
      --shadow: 0 12px 28px rgba(0,0,0,.08);
      --radius: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, #f3e7d5 0%, var(--bg) 40%, var(--bg) 100%);
      color:var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 56px 20px;
    }
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px 26px 18px;
    }
    h1{
      font-size: 26px;
      margin: 0 0 14px;
      letter-spacing: .2px;
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 10px;
    }
    input{
      height: 42px;
      padding: 0 14px;
      border-radius: 12px;
      border:1px solid var(--line);
      outline: none;
      font-size: 14px;
      background:#fff;
      min-width: 260px;
    }
    input:focus{ border-color:#d7c7b3; box-shadow: 0 0 0 4px rgba(215,199,179,.25); }
    button{
      height: 42px;
      padding: 0 14px;
      border-radius: 12px;
      border:1px solid transparent;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      background: var(--btn);
      color: var(--btnText);
    }
    button.secondary{
      background:#efefef;
      color:#111;
      border-color:#e6e6e6;
      font-weight: 600;
    }
    .meta{
      margin-left:auto;
      display:flex;
      gap:14px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .status{
      color: var(--danger);
      font-weight: 700;
      margin-left: 8px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 13px;
    }
    thead th{
      text-align:left;
      color:#3a3a3a;
      font-weight: 700;
      padding: 12px 10px;
      border-bottom: 1px solid var(--line);
    }
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid #f1eadf;
      color:#2b2b2b;
    }
    .empty{
      color: var(--muted);
      padding: 14px 10px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      font-size: 12px;
      color:#333;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Marina Kod Paneli</h1>

      <div class="row">
        <input id="codeInput" placeholder="Kasada okunan 6 haneli kod" inputmode="numeric" autocomplete="one-time-code" />
        <button id="btnUse">Kodu doğrula (kullanıldı yap)</button>
        <button class="secondary" id="btnRefresh">Listeyi yenile</button>

        <div class="meta">
          <span id="countText" class="badge">Son 0 kayıt</span>
          <span id="statusText" class="status"></span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Durum</th>
            <th>Kod</th>
            <th>Pedalstar</th>
            <th>Üretim</th>
            <th>Bitiş</th>
            <th>Kullanım</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="empty" colspan="6">Kayıt yok.</td></tr>
        </tbody>
      </table>

      <div class="hint" id="hint"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusEl = $("statusText");
  const countEl  = $("countText");
  const tbody    = $("tbody");
  const codeIn   = $("codeInput");
  const hintEl   = $("hint");

  // 1) URL'den token al
  const qs = new URLSearchParams(location.search);
  const TOKEN =
    (qs.get("token") || qs.get("admin_token") || "").trim();

  // Token yoksa sayfa çalışmasın
  if (!TOKEN) {
    statusEl.textContent = "Token yok. URL'ye ?token=... ekleyin.";
    hintEl.textContent = "Örnek: /dashboard?token=GL_ADMIN_....";
    return;
  }

  // 2) API wrapper: token'ı header ile gönderiyoruz (en sağlamı)
  async function apiFetch(fnName, { method="GET", body=null, qsObj=null } = {}) {
    const url = new URL(`/.netlify/functions/${fnName}`, location.origin);
    if (qsObj) Object.entries(qsObj).forEach(([k,v]) => url.searchParams.set(k, v));

    const res = await fetch(url.toString(), {
      method,
      headers: {
        "content-type": "application/json",
        "x-admin-token": TOKEN
      },
      body: body ? JSON.stringify(body) : null
    });

    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

    if (!res.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(msg="") { statusEl.textContent = msg; }
  function setCount(n) { countEl.textContent = `Son ${n} kayıt`; }

  function renderRows(rows) {
    if (!rows || rows.length === 0) {
      tbody.innerHTML = `<tr><td class="empty" colspan="6">Kayıt yok.</td></tr>`;
      setCount(0);
      return;
    }

    setCount(rows.length);

    tbody.innerHTML = rows.map(r => {
      const used = r.used_at ? "Kullanıldı" : "Aktif";
      const usedAt = r.used_at ? new Date(r.used_at).toLocaleString("tr-TR") : "-";
      const created = r.created_at ? new Date(r.created_at).toLocaleString("tr-TR") : "-";
      const exp = r.expires_at ? new Date(r.expires_at).toLocaleString("tr-TR") : "-";

      return `
        <tr>
          <td>${used}</td>
          <td><b>${(r.code || "-")}</b></td>
          <td>${(r.pedalstar_id || "-")}</td>
          <td>${created}</td>
          <td>${exp}</td>
          <td>${usedAt}</td>
        </tr>
      `;
    }).join("");
  }

  async function refresh() {
    setStatus("");
    try {
      // list function'ı rows döndürür (önceki yapına göre: { rows: [...] } veya direkt [...]
      const data = await apiFetch("list", { method: "GET" });
      const rows = Array.isArray(data) ? data : (data.rows || data.data || []);
      renderRows(rows);
    } catch (e) {
      setStatus(e.message || "Hata");
      // Unauthorized ise: token/env uyumsuz
      if ((e.message || "").toLowerCase().includes("unauthorized")) {
        hintEl.textContent =
          "Unauthorized: Netlify ADMIN_TOKEN ile URL'deki token bire bir aynı değil ya da env deploy'a yansımadı. Netlify env değerlerinde baş/son boşluk olmadığını kontrol et ve redeploy yap.";
      } else {
        hintEl.textContent = "";
      }
    }
  }

  async function useCode() {
    const code = (codeIn.value || "").trim();
    if (!code) return;

    setStatus("");
    try {
      await apiFetch("use", { method: "POST", body: { code } });
      codeIn.value = "";
      await refresh();
    } catch (e) {
      setStatus(e.message || "Hata");
    }
  }

  $("btnRefresh").addEventListener("click", refresh);
  $("btnUse").addEventListener("click", useCode);
  codeIn.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") useCode();
  });

  // ilk yük
  refresh();
})();
</script>
</body>
</html>
